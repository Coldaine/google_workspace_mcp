---
# Bitwarden-driven secret rendering (skeleton)
# Requires BW_SESSION exported on control node OR use Ansible Vault+API later.

- name: Assert bitwarden map provided
  assert:
    that: bitwarden_secret_map is defined
    fail_msg: "bitwarden_secret_map variable must be provided (dict of env_var -> {item_id, field})"

- name: Ensure working directory exists
  file:
    path: "{{ secret_output_dir | default('./') }}"
    state: directory

- name: Fetch Bitwarden items
  command: "bw get item {{ item.value.item_id }}"
  register: bw_item
  loop: "{{ dict(bitwarden_secret_map) | dict2items }}"
  when: not item.value.item_id.startswith('REPLACE-WITH')
  changed_when: false
  failed_when: bw_item.rc != 0

- name: Build env var map
  set_fact:
    rendered_env: "{{ rendered_env | default({}) | combine({ item.item.key: ( ( ( ( ( ( ( bw_item.stdout | from_json ).fields | default([]) ) | selectattr('name','equalto', item.item.value.field ) | list )[0].value ) if ( ( ( ( bw_item.stdout | from_json ).fields | default([]) ) | selectattr('name','equalto', item.item.value.field ) | list ) | length ) > 0 else ( (bw_item.stdout | from_json).login.username if item.item.value.field in ['client_id','username','user'] else (bw_item.stdout | from_json).login.password ) ) ) }) }}"
  loop: "{{ bw_item.results }}"
  when: rendered_env is not defined or True

- name: Create .env file from secrets
  copy:
    dest: "{{ secret_output_dir | default('./') }}/.env.generated"
    content: |
      # Generated by secret-management role - DO NOT COMMIT
      {% for k, v in rendered_env.items() %}{{ k }}={{ v }}
      {% endfor %}
    mode: '0600'
